/**
 * @preserve Copyright 2005-2014 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 */
!function(e,t){e.Views.QueuedThread=e.Views.CompositeBase.extend({template:t.templates.queued_thread,itemView:e.Views.Control,itemViewContainer:".thread-controls",className:"thread",modelEvents:{change:"render"},events:{"click .open-dialog":"openDialog","click .view-control":"viewDialog","click .track-control":"showTrack","click .ban-control":"showBan","click .geo-link":"showGeoInfo","click .first-message a":"showFirstMessage"},initialize:function(){this.lastStyles=[]},serializeData:function(){var t=this.model,i=e.Objects.Models.page,o=t.toJSON();return o.stateDesc=this.stateToDesc(t.get("state")),o.chatting=t.get("state")==t.STATE_CHATTING,o.tracked=i.get("showVisitors"),o.firstMessage&&(o.firstMessagePreview=o.firstMessage.length>30?o.firstMessage.substring(0,30)+"...":o.firstMessage),o},stateToDesc:function(t){var i=e.Localization;return t==this.model.STATE_QUEUE?i.get("In queue"):t==this.model.STATE_WAITING?i.get("Waiting for operator"):t==this.model.STATE_CHATTING?i.get("In chat"):t==this.model.STATE_CLOSED?i.get("Closed"):t==this.model.STATE_LOADING?i.get("Loading"):""},showGeoInfo:function(){var t=this.model.get("userIp");if(t){var i=e.Objects.Models.page,o=i.get("geoLink").replace("{ip}",t);e.Popup.open(o,"ip"+t,i.get("geoWindowParams"))}},openDialog:function(){var e=this.model;if(e.get("canOpen")||e.get("canView")){var t=!e.get("canOpen");this.showDialogWindow(t)}},viewDialog:function(){this.showDialogWindow(!0)},showDialogWindow:function(t){var i=this.model,o=i.id,s=e.Objects.Models.page;e.Popup.open(s.get("agentLink")+"/"+o+(t?"?viewonly=true":""),"ImCenter"+o,s.get("chatWindowParams"))},showTrack:function(){var t=this.model.id,i=e.Objects.Models.page;e.Popup.open(i.get("trackedLink")+"?thread="+t,"ImTracked"+t,i.get("trackedUserWindowParams"))},showBan:function(){var t=this.model,i=t.get("ban"),o=e.Objects.Models.page;e.Popup.open(o.get("banLink")+"/"+(i!==!1?i.id+"/edit":"add?thread="+t.id),"ImBan"+i.id,o.get("banWindowParams"))},showFirstMessage:function(){var e=this.model.get("firstMessage");e&&alert(e)}})}(Mibew,Handlebars);