/**
 * @preserve Copyright 2005-2014 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 */
!function(e){e.Objects.Models.Controls={},e.Objects.Models.Status={};var s=[],t=e.Application,o=t.module("Chat",{startWithParent:!1});o.addInitializer(function(o){var n=e.Objects,l=e.Objects.Models,a=e.Objects.Models.Controls,r=e.Objects.Models.Status;o.page&&l.page.set(o.page),l.thread=new e.Models.Thread(o.thread),l.user=new e.Models.ChatUser(o.user);var i=new e.Layouts.Chat;n.chatLayout=i,t.mainRegion.show(i);var d=new e.Collections.Controls;l.user.get("isAgent")||(a.userName=new e.Models.UserNameControl({weight:220}),d.add(a.userName),a.sendMail=new e.Models.SendMailControl({weight:200,link:o.links.mail,windowParams:o.windowsParams.mail}),d.add(a.sendMail)),l.user.get("isAgent")&&(a.redirect=new e.Models.RedirectControl({weight:200,link:o.links.redirect}),d.add(a.redirect),a.history=new e.Models.HistoryControl({weight:180,link:o.links.history,windowParams:o.windowsParams.history}),d.add(a.history)),a.sound=new e.Models.SoundControl({weight:160}),d.add(a.sound),a.refresh=new e.Models.RefreshControl({weight:140}),d.add(a.refresh),o.links.ssl&&(a.secureMode=new e.Models.SecureModeControl({weight:120,link:o.links.ssl}),d.add(a.secureMode)),a.close=new e.Models.CloseControl({weight:100}),d.add(a.close),n.Collections.controls=d,i.controlsRegion.show(new e.Views.ControlsCollection({collection:d})),r.message=new e.Models.StatusMessage({hideTimeout:5e3}),r.typing=new e.Models.StatusTyping({hideTimeout:5e3}),n.Collections.status=new e.Collections.Status([r.message,r.typing]),i.statusRegion.show(new e.Views.StatusCollection({collection:n.Collections.status})),l.user.get("isAgent")||(l.avatar=new e.Models.Avatar,i.avatarRegion.show(new e.Views.Avatar({model:l.avatar}))),n.Collections.messages=new e.Collections.Messages,l.messageForm=new e.Models.MessageForm(o.messageForm),i.messageFormRegion.show(new e.Views.MessageForm({model:l.messageForm})),i.messagesRegion.show(new e.Views.MessagesCollection({collection:n.Collections.messages})),l.soundManager=new e.Models.ChatSoundManager,s.push(n.server.callFunctionsPeriodically(function(){var s=e.Objects.Models.thread,t=e.Objects.Models.user;return[{"function":"update",arguments:{"return":{typing:"typing",canPost:"canPost"},references:{},threadId:s.get("id"),token:s.get("token"),lastId:s.get("lastId"),typed:t.get("typing"),user:!t.get("isAgent")}}]},function(s){return s.errorCode?void e.Objects.Models.Status.message.setMessage(s.errorMessage||"refresh failed"):(s.typing&&e.Objects.Models.Status.typing.show(),void e.Objects.Models.user.set({canPost:s.canPost||!1}))}))}),o.on("start",function(){e.Objects.server.restartUpdater()}),o.addFinalizer(function(){e.Objects.chatLayout.close();for(var t=0;t<s.length;t++)e.Objects.server.stopCallFunctionsPeriodically(s[t]);"undefined"!=typeof e.Objects.Models.avatar&&e.Objects.Models.avatar.finalize(),e.Objects.Collections.messages.finalize(),delete e.Objects.chatLayout,delete e.Objects.Models.thread,delete e.Objects.Models.user,delete e.Objects.Models.page,delete e.Objects.Models.avatar,delete e.Objects.Models.messageForm,delete e.Objects.Models.Controls,delete e.Objects.Models.Status,delete e.Objects.Collections.messages,delete e.Objects.Collections.controls,delete e.Objects.Collections.status})}(Mibew);